<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <style>
    .nav-icons {position:absolute;top:1em;right:1em}
    .nav-icons img {height:24px}
    .entries-grid {display:grid;grid-gap:1em;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));margin:2em auto}
    .chara-link a {display:block}
    .chara-link img {width:80px;height:80px}
    .part {padding:6px;margin:2px;border-radius:4px;cursor:pointer}
    .part:hover {background:rgba(0,0,0,.2)}
    .part.selected {background:lightskyblue}
    .part img {border-radius:4px;max-width:100px}
  </style>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-174467306-1"></script>
  <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-174467306-1');</script>
  <title>Dragalia Story Sprites</title>
</head>
<body>
  <div id="main" class="container" style="display:none;margin-top:2em;text-align:center">
    <h2>Dragalia Lost Story Sprites</h2>
    <div id="chara-entries" class="entries-grid"></div>
    <h3>Units with only one expression</h3>
    <div id="one-part-entries" class="entries-grid"></div>
    <h3>Units with no expressions</h3>
    <div id="partsless-entries" class="entries-grid"></div>
  </div>
  <div id="editor" style="display:none;min-height:100vh">
    <div style="height:100vh;padding:2em;overflow-y:auto;flex:1 0 415px;max-width:max(415px, 45vw);border-right:1px solid #ccc">
      <div class="custom-control custom-checkbox custom-control-inline" style="vertical-align:middle">
        <input type="checkbox" id="faceOnlyCheckbox" class="custom-control-input">
        <label class="custom-control-label" for="faceOnlyCheckbox">Hide background</label>
      </div>
      <button id="reset-btn" class="btn btn-outline-primary">Reset</button>
      <div id="parts-list" style="display:flex;flex-flow:row wrap;margin:1em -10px 0"></div>
    </div>
    <canvas id="canvas" title="Constructed image can be copied or saved via right-click menu" style="flex:none;align-self:center;margin:0 auto"></canvas>
  </div>
  <div class="nav-icons">
    <a id="home-link" href="#"><img src="https://fonts.gstatic.com/s/i/googlematerialicons/home/v7/gm_grey-48dp/2x/gm_home_gm_grey_48dp.png"></a>
    <a href="../about.html"><img src="https://fonts.gstatic.com/s/i/googlematerialicons/info/v9/gm_grey-48dp/2x/gm_info_gm_grey_48dp.png"></a>
  </div>
  <script>
    let base_image, parts_data, part_pos_x, part_pos_y;
    const homeLink = document.getElementById('home-link');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let id = window.location.search.substring(1);
  
    if (!id) {
      homeLink.href = '../';
      fetch('index.json')
        .then(response => response.json())
        .then(json => {
          renderAllCharacters(json);
        });
    } else {
      homeLink.href = './';
      renderSingleCharacter(id);
    }
    function toggleMain(show) {
      $('#main').toggle(show);
      $('#editor').css('display', show ? 'none' : 'flex');
    }
    function renderAllCharacters(data) {
      const entries = [];
      const onePartEntries = [];
      const partlessEntries = [];
      for (const entry of data['labels']) {
        const id = entry['id'];
        const label = entry['label'];
        if (data['onepart'].includes(id)) {
          onePartEntries.push(`<div class="chara-link"><a href="?${id}"><img src="${id}/${id}_parts_c000.png">${id}</a>${label}</div>`);
        } else if (data['partsless'].includes(id)) {
          partlessEntries.push(`<div class="chara-link"><a href="?${id}">${id}</a>${label}</div>`);
        } else {
          entries.push(`<div class="chara-link"><a href="?${id}"><img src="${id}/${id}_parts_c000.png">${id}</a>${label}</div>`);
        }
      }
      document.getElementById('chara-entries').innerHTML = entries.join('');
      document.getElementById('one-part-entries').innerHTML = onePartEntries.join('');
      document.getElementById('partsless-entries').innerHTML = partlessEntries.join('');
      toggleMain(true);
    }
    function renderSingleCharacter(id) {
      fetch(`${id}/index.json`)
          .then(response => response.json())
          .then(json => {
            parts_data = json;
            renderSingleCharacterInner(id);
          });
    }
    function renderSingleCharacterInner(id) {
      // Construct main content.
      const parts = [];
      for (const [part_id, alpha_index] of Object.entries(parts_data['parts']['images']).sort((a, b) => ((a[1] < b[1]) ? -1 : ((a[1] > b[1]) ? 1 : 0)))) {
        parts.push(`<a class="part" data-index="${alpha_index}"><img title="${part_id}" src="${id}/${id}_parts_c${part_id}.png"></a>`);
      }
      document.getElementById('parts-list').innerHTML = parts.join('');

      // Draw the base image onto the canvas.
      resetDimensions();
      base_image = new Image();
      base_image.onload = reset;
      base_image.src = `${id}/${id}_base.png`;

      $('#faceOnlyCheckbox').click(function() {
        resetDimensions();
        redraw();
      });
      $('.part').click(function() {
        // When a part is selected, deselect all other parts that have the same
        // alpha index. These are guaranteed to be mutually exclusive parts.
        if (!this.classList.contains('selected')) {
          $(`.selected[data-index="${this.dataset['index']}"]`).removeClass('selected');
        }
        $(this).toggleClass('selected');
        redraw();
      });
      $('#reset-btn').click(function() {
        reset();
        $('.selected').each(function() {
          $(this).removeClass('selected');
        });
      });
      toggleMain(false);
    }
    function resetDimensions() {
      if ($('#faceOnlyCheckbox').prop('checked')) {
        canvas.width = parts_data['parts']['size']['x'];
        canvas.height = parts_data['parts']['size']['y'];
        part_pos_x = 0;
        part_pos_y = 0;
      } else {
        canvas.width = parts_data['rect']['width'];
        canvas.height = parts_data['rect']['height'];
        part_pos_x = parts_data['parts']['position']['x'];
        part_pos_y = parts_data['parts']['position']['y'];
      }
    }
    function reset() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!$('#faceOnlyCheckbox').prop('checked')) {
        ctx.drawImage(base_image, 0, 0);
      }
    }
    function redraw() {
      reset();
      const cropToFace = $('#faceOnlyCheckbox').prop('checked');
      const selected = $('.selected');
      if (selected.length) {
        selected.each(function() {
          ctx.drawImage(this.firstChild, part_pos_x, part_pos_y);
        });
      } else if (cropToFace) {
        ctx.fillStyle = '#eee';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }
  </script>
</body>
</html>